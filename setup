#!/bin/bash

# Yosika Setup - Stylish Installer
set -e

# Colors and styling
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
UNDERLINE='\033[4m'
NC='\033[0m'
BG_BLUE='\033[44m'
BG_PURPLE='\033[45m'

# Box drawing characters
BOX_HORIZONTAL="â•"
BOX_VERTICAL="â•‘"
BOX_TOP_LEFT="â•”"
BOX_TOP_RIGHT="â•—"
BOX_BOTTOM_LEFT="â•š"
BOX_BOTTOM_RIGHT="â•"
BOX_CROSS="â•¬"
BOX_T_LEFT="â• "
BOX_T_RIGHT="â•£"
BOX_T_TOP="â•¦"
BOX_T_BOTTOM="â•©"

# ASCII Art
show_banner() {
    clear
    echo -e "${PURPLE}"
    echo ' â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— '
    echo ' â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—'
    echo '  â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘'
    echo '   â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘'
    echo '    â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘'
    echo '    â•šâ•â•    â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•'
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘    ${BOLD}${WHITE}AnonXMusic Deployment Suite v2.0${NC}${CYAN}          â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

print_box() {
    local width=$1
    local color=$2
    shift 2
    local title="$@"
    
    echo -ne "${color}${BOX_TOP_LEFT}"
    for ((i=0; i<width-2; i++)); do echo -ne "${BOX_HORIZONTAL}"; done
    echo -e "${BOX_TOP_RIGHT}${NC}"
    
    if [ ! -z "$title" ]; then
        echo -ne "${color}${BOX_VERTICAL}${NC}"
        echo -ne " ${BOLD}${WHITE}$title${NC}"
        for ((i=0; i<width-${#title}-3; i++)); do echo -ne " "; done
        echo -e "${color}${BOX_VERTICAL}${NC}"
        
        echo -ne "${color}${BOX_T_LEFT}"
        for ((i=0; i<width-2; i++)); do echo -ne "${BOX_HORIZONTAL}"; done
        echo -e "${BOX_T_RIGHT}${NC}"
    fi
}

print_box_bottom() {
    local width=$1
    local color=$2
    
    echo -ne "${color}${BOX_BOTTOM_LEFT}"
    for ((i=0; i<width-2; i++)); do echo -ne "${BOX_HORIZONTAL}"; done
    echo -e "${BOX_BOTTOM_RIGHT}${NC}"
}

print_line() {
    local width=$1
    local color=$2
    
    echo -ne "${color}${BOX_VERTICAL}${NC} $3"
    local text_len=${#3}
    for ((i=0; i<width-text_len-3; i++)); do echo -ne " "; done
    echo -e "${color}${BOX_VERTICAL}${NC}"
}

print_message() {
    local type=$1
    local message=$2
    
    case $type in
        "success")
            echo -e "${GREEN}âœ“${NC} ${BOLD}${message}${NC}"
            ;;
        "error")
            echo -e "${RED}âœ—${NC} ${BOLD}${message}${NC}"
            ;;
        "info")
            echo -e "${CYAN}â„¹${NC} ${message}${NC}"
            ;;
        "warning")
            echo -e "${YELLOW}âš ${NC} ${message}${NC}"
            ;;
        "step")
            echo -e "${PURPLE}â–¶${NC} ${BOLD}${WHITE}${message}${NC}"
            ;;
        "input")
            echo -e "${CYAN}?${NC} ${BOLD}${message}${NC}"
            ;;
    esac
}

print_progress() {
    local current=$1
    local total=$2
    local width=50
    local percent=$((current * 100 / total))
    local completed=$((current * width / total))
    local remaining=$((width - completed))
    
    echo -ne "\r${CYAN}[${NC}"
    for ((i=0; i<completed; i++)); do echo -ne "${GREEN}â–ˆ${NC}"; done
    for ((i=0; i<remaining; i++)); do echo -ne "â–‘"; done
    echo -ne "${CYAN}] ${percent}%${NC}"
}

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

yesno_prompt() {
    local prompt=$1
    echo -ne "${CYAN}?${NC} ${BOLD}${prompt}${NC} ${YELLOW}[y/N]${NC}: "
    
    old_stty=$(stty -g)
    stty raw -echo
    answer=$(head -c 1)
    stty $old_stty
    
    echo
    case $answer in
        y|Y) return 0 ;;
        *) return 1 ;;
    esac
}

# Functions
check_sudo() {
    print_box 60 "${CYAN}" "Privilege Check"
    print_line 60 "${CYAN}" "Checking for sudo privileges..."
    
    if sudo -n true 2>/dev/null; then
        print_message "success" "Sudo access confirmed"
    else
        print_message "info" "Script needs sudo privileges"
        echo -e "${YELLOW}Please enter your password when prompted${NC}"
        sudo test
        print_message "success" "Authentication successful"
    fi
    
    print_box_bottom 60 "${CYAN}"
    echo
}

update_system() {
    print_box 60 "${CYAN}" "System Update"
    print_line 60 "${CYAN}" "Updating package repositories..."
    
    if sudo apt update 2>&1 | grep -q "can be upgraded"; then
        print_message "success" "Updates available"
        print_message "info" "Checking for available upgrades..."
        
        upgrades=$(apt list --upgradable 2>/dev/null | wc -l)
        upgrades=$((upgrades - 1))
        
        if [ $upgrades -gt 0 ]; then
            print_message "info" "Found $upgrades packages to upgrade"
            if yesno_prompt "Do you want to upgrade all packages?"; then
                print_message "step" "Upgrading packages..."
                sudo apt upgrade -y 2>&1 | while read line; do
                    echo -ne "\r${CYAN}â–¶${NC} ${line:0:70}"
                done
                echo
                print_message "success" "System upgrade completed"
            else
                print_message "info" "Skipping package upgrades"
            fi
        fi
    else
        print_message "success" "System is up to date"
    fi
    
    print_box_bottom 60 "${CYAN}"
    echo
}

install_dependencies() {
    print_box 60 "${CYAN}" "Dependency Installation"
    
    # Check Python pip
    if ! command -v pip3 &>/dev/null; then
        print_message "step" "Installing Python pip..."
        if sudo apt install python3-pip -y >/dev/null 2>pypilog.txt; then
            print_message "success" "Python pip installed"
        else
            print_message "error" "Failed to install pip"
            exit 1
        fi
    else
        print_message "success" "Python pip already installed"
    fi
    
    # Check FFmpeg
    if ! command -v ffmpeg &>/dev/null; then
        print_message "step" "Installing FFmpeg..."
        if sudo apt install ffmpeg -y >/dev/null 2>&1; then
            print_message "success" "FFmpeg installed"
        else
            print_message "error" "Failed to install FFmpeg"
            print_message "info" "Please install FFmpeg manually: sudo apt install ffmpeg"
            exit 1
        fi
    else
        print_message "success" "FFmpeg already installed"
        
        # Check FFmpeg version
        ffmpeg_version=$(ffmpeg -version | grep -oP 'version \K[0-9]+\.[0-9]+' | head -1)
        major_version=$(echo $ffmpeg_version | cut -d. -f1)
        
        if [ $major_version -lt 4 ]; then
            print_message "warning" "FFmpeg version $ffmpeg_version detected"
            print_message "info" "Live streams require FFmpeg 4.0 or higher"
            print_message "info" "Consider upgrading: sudo apt install ffmpeg -t bullseye-backports"
        fi
    fi
    
    print_box_bottom 60 "${CYAN}"
    echo
}

install_nodejs() {
    print_box 60 "${CYAN}" "Node.js Installation"
    
    if command -v node &>/dev/null && command -v npm &>/dev/null; then
        print_message "success" "Node.js and npm already installed"
        node_version=$(node --version)
        npm_version=$(npm --version)
        print_message "info" "Node: $node_version, npm: $npm_version"
    else
        print_message "step" "Installing Node.js 19.x and npm..."
        
        # Install Node.js
        curl -fsSL https://deb.nodesource.com/setup_19.x 2>/dev/null | sudo -E bash - >/dev/null 2>&1 &
        pid=$!
        spinner $pid
        wait $pid
        
        if sudo apt install -y nodejs >/dev/null 2>&1; then
            print_message "success" "Node.js installed"
            
            # Update npm
            print_message "step" "Updating npm to latest version..."
            sudo npm i -g npm >/dev/null 2>&1 &
            pid=$!
            spinner $pid
            wait $pid
            
            print_message "success" "npm updated"
            node_version=$(node --version)
            npm_version=$(npm --version)
            print_message "info" "Node: $node_version, npm: $npm_version"
        else
            print_message "error" "Failed to install Node.js"
            exit 1
        fi
    fi
    
    print_box_bottom 60 "${CYAN}"
    echo
}

install_python_packages() {
    print_box 60 "${CYAN}" "Python Packages"
    
    print_message "step" "Upgrading pip..."
    if pip3 install -U pip >/dev/null 2>&1; then
        print_message "success" "pip upgraded"
    else
        print_message "warning" "pip upgrade failed, continuing..."
    fi
    
    print_message "step" "Installing Python dependencies..."
    
    # Count lines in requirements.txt for progress
    if [ -f "requirements.txt" ]; then
        total_packages=$(wc -l < requirements.txt)
        current=0
        
        while read package; do
            current=$((current + 1))
            print_progress $current $total_packages
            pip3 install -U "$package" >/dev/null 2>&1
        done < requirements.txt
        
        echo
        print_message "success" "All Python packages installed ($total_packages packages)"
    else
        print_message "error" "requirements.txt not found!"
        exit 1
    fi
    
    print_box_bottom 60 "${CYAN}"
    echo
}

get_configuration() {
    print_box 60 "${PURPLE}" "Configuration Setup"
    print_line 60 "${PURPLE}" "Please enter your configuration details"
    print_line 60 "${PURPLE}" ""
    
    # API Configuration
    print_message "input" "Enter your API ID:"
    echo -ne "${CYAN}â†’${NC} "
    read api_id
    
    print_message "input" "Enter your API Hash:"
    echo -ne "${CYAN}â†’${NC} "
    read api_hash
    
    print_message "input" "Enter your Bot Token:"
    echo -ne "${CYAN}â†’${NC} "
    read bot_token
    
    print_message "input" "Enter your Owner ID:"
    echo -ne "${CYAN}â†’${NC} "
    read owner_id
    
    print_message "input" "Enter your MongoDB URI:"
    echo -ne "${CYAN}â†’${NC} "
    read mongo_uri
    
    print_message "input" "Enter your Log Group ID:"
    echo -ne "${CYAN}â†’${NC} "
    read log_group
    
    print_message "input" "Enter your String Session:"
    echo -ne "${CYAN}â†’${NC} "
    read string_session
    
    # Validate inputs
    print_message "step" "Validating configuration..."
    
    if [ -z "$api_id" ] || [ -z "$api_hash" ] || [ -z "$bot_token" ]; then
        print_message "error" "API ID, API Hash, and Bot Token are required!"
        exit 1
    fi
    
    # Save to .env
    cat > .env << EOF
# Yosika Music Bot Configuration
# Generated on $(date)

# Telegram API Configuration
API_ID = $api_id
API_HASH = $api_hash
BOT_TOKEN = $bot_token
STRING_SESSION = $string_session

# Database Configuration
MONGO_DB_URI = $mongo_uri

# Bot Settings
OWNER_ID = $owner_id
LOGGER_ID = $log_group

# Additional Settings (You can modify these)
SESSION_STRING = $string_session
EOF
    
    print_message "success" "Configuration saved to .env file"
    print_box_bottom 60 "${PURPLE}"
}

show_summary() {
    print_box 60 "${GREEN}" "Installation Complete"
    print_line 60 "${GREEN}" ""
    print_line 60 "${GREEN}" "${BOLD}${WHITE}ğŸ‰ Yosika Setup Completed Successfully!${NC}"
    print_line 60 "${GREEN}" ""
    print_line 60 "${GREEN}" "${CYAN}Next Steps:${NC}"
    print_line 60 "${GREEN}" "1. Review your configuration in .env file"
    print_line 60 "${GREEN}" "2. Start the bot with: ${WHITE}bash start${NC}"
    print_line 60 "${GREEN}" "3. Or use: ${WHITE}python3 -m AnonXMusic${NC}"
    print_line 60 "${GREEN}" ""
    print_line 60 "${GREEN}" "${YELLOW}Need help?${NC}"
    print_line 60 "${GREEN}" "Check logs in: nodelog.txt, pypilog.txt"
    print_line 60 "${GREEN}" ""
    print_line 60 "${GREEN}" "${PURPLE}Thank you for using Yosika Setup!${NC}"
    print_box_bottom 60 "${GREEN}"
    
    echo
    echo -e "${BOLD}${WHITE}Quick Start Commands:${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}â–¶${NC} Start bot:        ${WHITE}bash start${NC}"
    echo -e "${GREEN}â–¶${NC} Check logs:       ${WHITE}tail -f nohup.out${NC}"
    echo -e "${GREEN}â–¶${NC} Edit config:      ${WHITE}nano .env${NC}"
    echo -e "${GREEN}â–¶${NC} View status:      ${WHITE}ps aux | grep AnonXMusic${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# Main execution
main() {
    show_banner
    
    print_message "info" "Starting Yosika Setup for AnonXMusic"
    print_message "info" "Logs will be saved to nodelog.txt and pypilog.txt"
    echo
    
    # Check for sudo
    check_sudo
    
    # Update system
    update_system
    
    # Install dependencies
    install_dependencies
    
    # Install Node.js
    install_nodejs
    
    # Install Python packages
    install_python_packages
    
    # Get configuration
    get_configuration
    
    # Show summary
    show_summary
    
    # Cleanup
    rm -f nodelog.txt pypilog.txt 2>/dev/null
}

# Run main function
main "$@"
